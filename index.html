<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIEWROS GPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="graphics/mp4b_routing_favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="graphics/mp4b_routing_favicon.png">
    <link rel="apple-touch-icon" href="graphics/mp4b_routing_favicon.png">
</head>
<body>
    <div id="loadFade" aria-hidden="true">
        <div class="loader" role="img" aria-label="Loading">
            <div class="logo-stack" aria-hidden="true">
                <img src="graphics/mp4b_routing_logo_ball.svg" alt="" class="loading-logo logo-ball">
                <img src="graphics/mp4b_routing_logo_geotag.svg" alt="" class="logo-geotag">
            </div>
        </div>
    </div>
    <div class="app-container">
        <aside class="sidebar">
            <div class="header">
                <div class="logo-stack" aria-hidden="true">
                    <img src="graphics/mp4b_routing_logo_ball.svg" alt="" class="logo-ball">
                    <img src="graphics/mp4b_routing_logo_geotag.svg" alt="" class="logo-geotag">
                </div>
                <div class="title-block">
                    <h1>VIEWROS GPS</h1>
                    <h2>S O L  V A L L E Y</h2>
                </div>
            </div>
            
            <div class="controls">
                
                

                <div class="control-group section-glow">
                    <h3>L a y e r s \ \ \</h3>
                    <div class="layer-controls-inline" style="margin-bottom:8px; display:flex; gap:8px;">
                        <button id="showAllLayersBtn" class="control-btn">Show All</button>
                        <button id="hideAllLayersBtn" class="control-btn">Hide All</button>
                    </div>
                    <div id="layerList"></div>
                </div>

                <div class="control-group section-glow">
                    <h3>M a p p i n g \ \ \</h3>
                    <div class="tileset-controls">
                        <button id="tilesetSatBtn" class="control-toggle" aria-pressed="false">Satellite</button>
                        <button id="tilesetHoloBtn" class="control-toggle" aria-pressed="false">Holographic</button>
                        <button id="tilesetGrayscaleBtn" class="control-toggle" aria-pressed="false">Grayscale</button>
                    </div>
                </div>
            
                <div class="control-group section-glow">
                    <h3>R o u t i n g \ \ \</h3>
                    <button id="editRouteToggle" class="control-toggle" aria-pressed="false" aria-label="Edit Route">Edit Route</button>
                    <button id="computeRouteImprovedBtn" class="control-btn">Compute Route</button>
                    <button id="computeRouteNearbyBtn" class="control-btn">Expand Route</button>
                    <button id="loopRouteBtn" class="control-toggle" aria-pressed="false">Loop Route</button>
                    <button id="toggleRouteDirBtn" class="control-toggle" aria-pressed="false">Reverse Route</button>
                    <button id="exportRoute" class="control-btn">Export Route</button>
                    <button id="importRoute" class="control-btn">Import Route</button>
                    <button id="clearRouteBtn" class="control-btn danger">Clear Route</button>
                </div>
                
                <div class="control-group section-glow" id="customMarkerControls">
                    <h3>M a r k e r s \ \ \</h3>
                    <button id="editMarkersToggle" class="control-toggle" aria-pressed="false" aria-label="Edit Markers">Edit Markers</button>
                    <button id="exportCustom" class="control-btn">Export Markers</button>
                    <button id="importCustom" class="control-btn">Import Markers</button>
                    <button id="clearCustom" class="control-btn danger">Clear Markers</button>
                    <input type="file" id="importFile" accept=".json" style="display:none;">
                    <input type="file" id="importRouteFile" accept=".json" style="display:none;">
                </div>

                <div class="control-group section-glow" id="settingsSection">
                    <h3>S e t t i n g s \ \ \</h3>
                    <div class="settings-row">
                        <label for="highlightScaleSlider">Highlight Size: <span id="highlightScaleValue">1.0x</span></label>
                        <input id="highlightScaleSlider" type="range" min="0.6" max="4.0" step="0.05" value="1.0" />
                    </div>
                </div>

                <div class="control-group section-glow" id="devTools">
                    <h3>D e v   T o o l s \ \ \</h3>
                    <div id="devStatsPanel" class="dev-stats" aria-live="polite">
                        <div class="dev-row"><div class="dev-label">Decoders active</div><div class="dev-value" id="dev_bitmapActive">0</div></div>
                        <div class="dev-row"><div class="dev-label">Decode queue</div><div class="dev-value" id="dev_bitmapQueue">0</div></div>
                        <div class="dev-row"><div class="dev-label">Active fetches</div><div class="dev-value" id="dev_imageControllers">0</div></div>
                            <div class="dev-row"><div class="dev-label">Cached bitmaps</div><div class="dev-value" id="dev_imageBitmaps">0</div></div>
                            <div class="dev-row"><div class="dev-label">Zoom</div><div class="dev-value" id="zoomStatus">10%</div></div>
                            <div class="dev-row"><div class="dev-label">Resolution</div><div class="dev-value" id="resolutionStatus">256px</div></div>
                    </div>
                </div>

                <div class="control-group section-glow" id="linksSection">
                    <h3>L i n k s \ \ \</h3>
                    <button id="githubBtn" class="control-btn">GitHub Repository</button>
                    <button id="discordBtn" class="control-btn">Discord Community</button>
                </div>

                <div class="control-group section-glow" id="dataminersSection">
                    <h3>C o n t r i b u t o r s \ \ \</h3>
                    <div class="dataminers-list">
                        <div class="dataminer-row"><div class="dataminer-label">Cryptic Jacknife</div></div>
                        <div class="dataminer-row"><div class="dataminer-label">Meta_X</div></div>
                        <div class="dataminer-row"><div class="dataminer-label">Supreme Dirt</div></div>
                        <div class="dataminer-row"><div class="dataminer-label">rekameohs</div></div>
                        <div class="dataminer-row"><div class="dataminer-label">Tal</div></div>
                    </div>
                </div>
            </div>
            
            <!-- Footer: contains hints and consent (kept at bottom of sidebar) -->
            <div class="sidebar-footer">
                <!-- Hints overlay: moved to be part of the footer (hidden by default) -->
                <div class="hints-overlay" id="hintsOverlay" aria-hidden="true">
                    <div class="hints-list" id="hintsList">
                        <span class="hint-group"><kbd>E</kbd>/<kbd>⇡</kbd> <span class="hint-label">Edit Route</span></span>
                        <span class="hint-group"><kbd>C</kbd>/<kbd>↔</kbd> <span class="hint-label">Expand Route</span></span>
                        <span class="hint-group"><kbd>&lt;</kbd>/<kbd>⇄</kbd> <span class="hint-label">Reverse Route</span></span>
                        <span class="hint-group"><kbd>Y</kbd> <span class="hint-label">Clear Route</span></span>

                        <span class="hint-group"><kbd>E</kbd>/<kbd>⚲</kbd> <span class="hint-label">Edit Custom Markers</span></span>
                        <span class="hint-group"><kbd>X</kbd> <span class="hint-label">Clear Custom Markers</span></span>

                        <span class="hint-group"><kbd>+</kbd>/<kbd>-</kbd>/<kbd>Pinch</kbd> <span class="hint-label">Zoom</span></span>

                        <span class="hint-group"><kbd>W</kbd>/<kbd>A</kbd>/<kbd>S</kbd>/<kbd>D</kbd>/<kbd>Drag</kbd> <span class="hint-label">Pan</span></span>
                        <span class="hint-group"><kbd>Shift</kbd> <span class="hint-label">Dash</span></span>
                        <span class="hint-group"><kbd>0</kbd>/<kbd>⛶</kbd> <span class="hint-label">Reset View</span></span>

                        <span class="hint-group"><kbd>1</kbd>/<kbd>2</kbd>/<kbd>3</kbd> <span class="hint-label">Mapstyle / Grayscale</span></span>

                        <span class="hint-group"><kbd>Escape</kbd> <span class="hint-label">Exit Edit Modes</span></span>

                        <span class="hint-group"><kbd>Space</kbd>/<kbd>☰</kbd> <span class="hint-label">Toggle sidebar</span></span>
                    </div>
                </div>

                <!-- Hints button at bottom of controls (closed by default) -->
                <button id="hintsToggleBtn" class="hints-toggle control-toggle" aria-expanded="false" aria-controls="hintsList" aria-pressed="false">Controls</button>

                <!-- Local Storage (consent) toggle -->
                <button type="button" class="control-toggle" id="saveDataToggle_label" aria-pressed="false">
                    <div class="layer-info">
                        <div class="layer-name">Local Storage Consent</div>
                    </div>
                </button>
            </div>

        </aside>
        <!-- Sidebar toggle handle will be placed inside zoom-controls (static, no animation) -->
        
        <main class="map-container">
            <!-- Background tile canvas (drawn in task 2). Marked aria-hidden since it's decorative. -->
            <canvas id="mapTiles" aria-hidden="true"></canvas>
            <!-- Overlay canvas for routes & markers (keeps existing id for compatibility with map.js) -->
            <canvas id="mapCanvas"></canvas>
            <div id="editOverlay" class="edit-overlay" aria-hidden="true"></div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                <button class="zoom-btn" id="zoomOut" title="Zoom Out">−</button>
                <button class="zoom-btn" id="resetView" title="Reset View" aria-label="Reset View"><span class="mini-icon">⛶</span></button>
                <div class="mini-row">
                    <button id="editRouteToggleMini" class="zoom-btn" aria-pressed="false" title="Edit Route" aria-label="Edit Route">
                        <span class="mini-icon">⇡</span>
                    </button>
                    <button id="computeRouteNearbyMini" class="zoom-btn" title="Expand Route" aria-label="Expand Route"><span class="mini-icon">↔</span></button>
                    <button id="toggleRouteDirMini" class="zoom-btn" title="Reverse Route" aria-label="Reverse Route"><span class="mini-icon">⇄</span></button>
                    <button id="editMarkersToggleMini" class="zoom-btn" aria-pressed="false" title="Edit Markers" aria-label="Edit Markers">
                        <span class="mini-icon">⚲</span>
                    </button>
                </div>
                <button class="zoom-btn" id="sidebarHandle" title="Toggle sidebar" aria-label="Toggle sidebar" ><span class="mini-icon">☰</span></button>
            </div>
        </main>
    </div>
    
    <div id="tooltip"></div>
    
    <script src="data/init.js"></script>
    
    <script src="data/layers/lamornStatue.js"></script>
    <script src="data/layers/gfDebris.js"></script>
    <script src="data/layers/tokabisCamp.js"></script>
    <script src="data/layers/shrineLift.js"></script>
    <script src="data/layers/saveStation.js"></script>
    <script src="data/layers/areaEntrance.js"></script>
    <script src="data/layers/scoutBot.js"></script>
    <script src="data/layers/mechPart.js"></script>
    <script src="data/layers/bombExpansion.js"></script>
    <script src="data/layers/shotExpansion.js"></script>
    <script src="data/layers/missileExpansion.js"></script>
    <script src="data/layers/shotUpgrade.js"></script>
    <script src="data/layers/energyTank.js"></script>
    <script src="data/layers/boostTank.js"></script>
    <script src="data/layers/gibardaumRock.js"></script>
    <script src="data/layers/geCrystallization3.js"></script>
    <script src="data/layers/geCrystallization2.js"></script>
    <script src="data/layers/geCrystallization1.js"></script>
    <script src="data/layers/customMarkers.js"></script>
    <script src="data/layers/route.js"></script>
    <script src="data/storageHelper.js"></script>
    <script src="data/markerUtils.js"></script>

    <script src="data/routeUtils.js"></script>
    <script src="tools/tsp_euclid.js"></script>

    <script src="map.js"></script>
    <script src="data/ripple.js"></script>
    <script>
    // Prevent double-click zoom on the entire page
    (function(){
        let lastClickTime = 0;
        document.addEventListener('dblclick', function(e) {
            // Allow double-click zoom only on the map canvas; block everywhere else
            if (e.target.id !== 'mapCanvas' && e.target.id !== 'mapTiles') {
                e.preventDefault();
            }
        }, false);

        // Block Ctrl+wheel browser zoom globally to prevent accidental page zoom
        // This also catches trackpad pinch-to-zoom gestures that browsers map to ctrlKey+wheel
        document.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
            }
        }, { passive: false });
        
        function removeFade(){
            var el = document.getElementById('loadFade');
            if(!el) return;
            // Trigger fade-out
            el.classList.add('fade-out');
            // Remove node after transition so it doesn't block interaction
            var done = function(){ if(el && el.parentNode) el.parentNode.removeChild(el); };
            el.addEventListener('transitionend', done, { once: true });
            // Fallback: remove after 1s if transitionend doesn't fire
            setTimeout(done, 1200);
        }
        // Wait for the app to signal readiness (startup work completed) before
        // removing the loading fade. Use a timeout fallback to avoid hanging
        // the UI forever if the event isn't fired for some reason.
        try {
            document.addEventListener('mp4-ready', removeFade, { once: true });
            // Fallback: ensure fade removed after 7s even if event not fired
            setTimeout(() => { try { removeFade(); } catch (e) {} }, 7000);
        } catch (e) {
            // As a final fallback, remove fade on window load
            if (document.readyState === 'complete') removeFade(); else window.addEventListener('load', removeFade);
        }
    })();
    </script>
</body>
</html>
